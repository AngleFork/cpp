



 

 

 

 

 

([C++](Cpp.htm)) [QtGraphExample5](CppQtGraphExample5.htm)
==========================================================

 

Technical facts
---------------

 

[Operating system(s) or programming environment(s)](CppOs.htm)

-   ![Lubuntu](PicLubuntu.png) [Lubuntu](CppLubuntu.htm) 15.04 (vivid)

[IDE(s)](CppIde.htm):

-   ![Qt Creator](PicQtCreator.png) [Qt Creator](CppQtCreator.htm) 3.1.1

[Project type](CppQtProjectType.htm):

-   ![console](PicConsole.png) [Console
    application](CppConsoleApplication.htm)

[C++ standard](CppStandard.htm):

-   ![C++98](PicCpp98.png) [C++98](Cpp98.htm)

[Compiler(s)](CppCompiler.htm):

-   [G++](CppGpp.htm) 4.9.2

[Libraries](CppLibrary.htm) used:

-   ![STL](PicStl.png) [STL](CppStl.htm): GNU ISO C++ Library, version
    4.9.2

 

 

 

 

 

[Qt project file](CppQtProjectFile.htm): ./CppQtGraphExample5/CppQtGraphExample5.pro
------------------------------------------------------------------------------------

 

  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  ` include(../../DesktopApplication.pri) include(../../Libraries/Boost.pri)  SOURCES += \     edge.cpp \     graphwidget.cpp \     main.cpp \     node.cpp  HEADERS += \     edge.h \     graphwidget.h \     node.h`
  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 

 

 

 

 

./CppQtGraphExample5/edge.h
---------------------------

 

  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  ` // Adapted from Qt example 'Elastic nodes' // http://qt-project.org/doc/qt-4.8/graphicsview-elasticnodes.html  #ifndef EDGE_H #define EDGE_H  #include <QGraphicsItem>  class Node;  class Edge : public QGraphicsItem { public:   Edge(Node * const source_node, Node * const dest_node);   Edge(const Edge&) = delete;   Edge& operator=(const Edge&) = delete;    Node * sourceNode() const noexcept;   Node * destNode() const noexcept;    void adjust() noexcept;    enum { Type = UserType + 2 };   int type() const { return Type; }  protected:   QRectF boundingRect() const;   void paint(QPainter *painter, const QStyleOptionGraphicsItem *option, QWidget *widget);  private:   const double m_arrow_size;   Node * const m_dest_node;   QPointF m_dest_point;   bool m_show_bounding_rect;   Node * const m_source_node;   QPointF m_source_point; };   #endif`
  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 

 

 

 

 

./CppQtGraphExample5/edge.cpp
-----------------------------

 

  -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  ` // Adapted from Qt example 'Elastic nodes' // http://qt-project.org/doc/qt-4.8/graphicsview-elasticnodes.html #include "edge.h"   #include <QPainter> #include <QStyleOption> #include "node.h"  #include <boost/math/constants/constants.hpp>  Edge::Edge(Node * const source_node, Node * const dest_node)   :     m_arrow_size{10.0},     m_dest_node{dest_node},     m_dest_point{0.0,0.0},     m_show_bounding_rect{false},     m_source_node{source_node},     m_source_point{0.0,0.0} {   this->setFlags(       ItemIsFocusable     | ItemIsSelectable   );   m_source_node->addEdge(this);   m_dest_node->addEdge(this);   adjust(); }  Node * Edge::sourceNode() const noexcept {   return m_source_node; }  Node * Edge::destNode() const noexcept {   return m_dest_node; }  void Edge::adjust() noexcept {   if (!m_source_node || !m_dest_node) return;    const QLineF line(mapFromItem(m_source_node, 0, 0), mapFromItem(m_dest_node, 0, 0));   const double length{line.length()};    prepareGeometryChange();    if (length > 20.0)   {     const QPointF edgeOffset((line.dx() * 10) / length, (line.dy() * 10) / length);     m_source_point = line.p1() + edgeOffset;     m_dest_point = line.p2() - edgeOffset;   }   else   {     m_source_point = m_dest_point = line.p1();   } }  QRectF Edge::boundingRect() const {   if (!m_source_node || !m_dest_node) return QRectF();    const double penWidth{1.0};   const double extra{(penWidth + m_arrow_size) / 2.0};    return QRectF(     m_source_point,     QSizeF(m_dest_point.x() - m_source_point.x(),       m_dest_point.y() - m_source_point.y()     )   ).normalized()    .adjusted(-extra, -extra, extra, extra); }  void Edge::paint(QPainter *painter, const QStyleOptionGraphicsItem * option, QWidget *) {   if (!m_source_node || !m_dest_node) return;    const double pi{boost::math::constants::pi<double>()};   const double tau{boost::math::constants::two_pi<double>()};     const QLineF line(m_source_point, m_dest_point);    if (qFuzzyCompare(line.length(), 0.0)) return;    // Draw the line itself   const bool is_selected{option->state & QStyle::State_Sunken || isSelected()};   painter->setPen(     QPen(       Qt::black,       1.0,       is_selected ? Qt::DashLine : Qt::SolidLine,       Qt::RoundCap,       Qt::RoundJoin     )   );   painter->drawLine(line);    painter->setPen(     QPen(       Qt::black,       1.0,       Qt::SolidLine, //The point must be drawn with solidLine       Qt::RoundCap,       Qt::RoundJoin     )   );    // Draw the arrows   double angle = std::acos(line.dx() / line.length());   if (line.dy() >= 0) angle = tau - angle;    using std::sin;   using std::cos;   const QPointF sourceArrowP1{m_source_point + QPointF(sin(angle + pi / 3.0) * m_arrow_size,cos(angle + pi / 3.0) * m_arrow_size)};   const QPointF sourceArrowP2{m_source_point + QPointF(sin(angle + pi - pi / 3.0) * m_arrow_size,cos(angle + pi - pi / 3.0) * m_arrow_size)};   const QPointF destArrowP1{m_dest_point + QPointF(sin(angle - pi / 3.0) * m_arrow_size,cos(angle - pi / 3.0) * m_arrow_size)};   const QPointF destArrowP2{m_dest_point + QPointF(sin(angle - pi + pi / 3.0) * m_arrow_size,cos(angle - pi + pi / 3.0) * m_arrow_size)};    painter->setBrush(Qt::black);   painter->drawPolygon(QPolygonF() << line.p1() << sourceArrowP1 << sourceArrowP2);   painter->drawPolygon(QPolygonF() << line.p2() << destArrowP1 << destArrowP2);    //Draw the bounding rectangle   if (m_show_bounding_rect)   {     painter->setBrush(QBrush(QColor(0,0,255,32)));     painter->setPen(QPen(QColor(0,0,255,64)));     painter->drawRect(this->boundingRect());   } }`
  -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 

 

 

 

 

./CppQtGraphExample5/graphwidget.h
----------------------------------

 

  ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  ` // Adapted from Qt example 'Elastic nodes' // http://qt-project.org/doc/qt-4.8/graphicsview-elasticnodes.html  #ifndef GRAPHWIDGET_H #define GRAPHWIDGET_H  #include <QGraphicsView>  class Node;  class GraphWidget : public QGraphicsView {   Q_OBJECT  public:   GraphWidget(QWidget *parent = 0);   GraphWidget(const GraphWidget&) = delete;   GraphWidget& operator=(const GraphWidget&) = delete;    ///Create a new node. The Node* is managed by GraphWidget   Node* createNode() noexcept;    void itemMoved() noexcept;  public slots:   void shuffle() noexcept;   void zoomIn() noexcept;   void zoomOut() noexcept;  protected:   void keyPressEvent(QKeyEvent *event) noexcept override;   void timerEvent(QTimerEvent *event) noexcept override;   void wheelEvent(QWheelEvent *event) noexcept override;   void scaleView(qreal scaleFactor) noexcept;  private:   int m_timer_id;   Node * m_active_node; //The current active node };  #endif`
  ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 

 

 

 

 

./CppQtGraphExample5/graphwidget.cpp
------------------------------------

 

  -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  ` // Adapted from Qt example 'Elastic nodes' // http://qt-project.org/doc/qt-4.8/graphicsview-elasticnodes.html  #include "graphwidget.h" #include <cmath>  #include <QGraphicsScene> #include <QKeyEvent>  #include "edge.h" #include "node.h"  GraphWidget::GraphWidget(QWidget *parent) : QGraphicsView(parent),   m_timer_id{0},   m_active_node{new Node(this)} {   QGraphicsScene * const scene = new QGraphicsScene(this);   scene->setItemIndexMember function(QGraphicsScene::NoIndex);   //Make the scene infinitely large   //scene->setSceneRect(-200, -200, 400, 400);   setScene(scene);   setCacheMode(CacheBackground);   setViewportUpdateMode(BoundingRectViewportUpdate);   setRenderHint(QPainter::Antialiasing);   setTransformationAnchor(AnchorUnderMouse);   scale(0.8, 0.8);   setMinimumSize(400, 400);   setWindowTitle(tr("Elastic Nodes"));    std::vector<Node*> nodes;   for (int y=-1; y!=2; ++y)   {     for (int x=-1; x!=2; ++x)     {       const auto node = createNode();       node->setPos(static_cast<double>(x) * 50.0, static_cast<double>(y) * 50.0);       nodes.push_back(node);     }    }   m_active_node = nodes[4];   scene->addItem(new Edge(nodes[0],nodes[1]));   scene->addItem(new Edge(nodes[0],nodes[3]));   scene->addItem(new Edge(nodes[1],nodes[2]));   scene->addItem(new Edge(nodes[1],nodes[4]));   scene->addItem(new Edge(nodes[2],nodes[5]));   scene->addItem(new Edge(nodes[3],nodes[4]));   scene->addItem(new Edge(nodes[3],nodes[6]));   scene->addItem(new Edge(nodes[4],nodes[5]));   scene->addItem(new Edge(nodes[4],nodes[7]));   scene->addItem(new Edge(nodes[5],nodes[8]));   scene->addItem(new Edge(nodes[6],nodes[7]));   scene->addItem(new Edge(nodes[7],nodes[8]));   m_active_node->setSelected(true); }  Node* GraphWidget::createNode() noexcept {   Node * const new_node{new Node(this)};   this->scene()->addItem(new_node);   return new_node; }  void GraphWidget::itemMoved() noexcept {   if (!m_timer_id)   {     m_timer_id = startTimer(1000 / 25);   } }  void GraphWidget::keyPressEvent(QKeyEvent *event) noexcept {   std::vector<Node*> nodes;   foreach(QGraphicsItem * const item, scene()->selectedItems())   {     Node * const node{dynamic_cast<Node*>(item)};     if (node) nodes.push_back(node);   }    switch (event->key())   {     case Qt::Key_Up:     {       foreach(Node * const node, nodes) { node->moveBy(0.0,-20.0); }     }     break;     case Qt::Key_Down:     {       foreach(Node * const node, nodes) { node->moveBy(0.0,20.0); }     }     break;     case Qt::Key_Left:     {       foreach(Node * const node, nodes) { node->moveBy(-20.0,0.0); }     }     break;     case Qt::Key_Right:     {       foreach(Node * const node, nodes) { node->moveBy(20,0); }     }     break;     case Qt::Key_Plus:       zoomIn();     break;     case Qt::Key_Minus:       zoomOut();     break;     case Qt::Key_Space:     case Qt::Key_Enter:       shuffle();     break;     default:       QGraphicsView::keyPressEvent(event);   } }  void GraphWidget::timerEvent(QTimerEvent *) noexcept {     QList<Node *> nodes;   foreach (QGraphicsItem *item, scene()->items())   {     if (Node * const node = qgraphicsitem_cast<Node *>(item))     {       nodes << node;     }   }   foreach (Node * const node, nodes)   {     node->calculateForces();   }    bool itemsMoved = false;   foreach (Node * const node, nodes)   {     if (node->advance())     itemsMoved = true;   }    if (!itemsMoved)   {     killTimer(m_timer_id);     m_timer_id = 0;   } }  void GraphWidget::wheelEvent(QWheelEvent *event) noexcept {   scaleView(std::pow(2.0, -event->delta() / 240.0)); }  void GraphWidget::scaleView(qreal scaleFactor) noexcept {   const double factor{     transform().scale(scaleFactor, scaleFactor)       .mapRect(QRectF(0.0, 0.0, 1.0, 1.0)).width()   };   if (factor < 0.07 || factor > 100.0) return;    scale(scaleFactor, scaleFactor); }  void GraphWidget::shuffle() noexcept {   foreach (QGraphicsItem * const item, scene()->items())   {     if (qgraphicsitem_cast<Node *>(item))     {       item->setPos(         static_cast<double>(-150 + (qrand() % 300)),         static_cast<double>(-150 + (qrand() % 300))       );     }   } }  void GraphWidget::zoomIn() noexcept {   scaleView(1.2); }  void GraphWidget::zoomOut() noexcept {   scaleView(1.0/1.2); }`
  -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 

 

 

 

 

./CppQtGraphExample5/main.cpp
-----------------------------

 

  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  ` // Adapted from Qt example 'Elastic nodes' // http://qt-project.org/doc/qt-4.8/graphicsview-elasticnodes.html  #include <QApplication>  #include "graphwidget.h"  int main(int argc, char **argv) {   QApplication app(argc, argv);   GraphWidget * const widget{new GraphWidget};   widget->show();   return app.exec(); }`
  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 

 

 

 

 

./CppQtGraphExample5/node.h
---------------------------

 

  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  ` // Adapted from Qt example 'Elastic nodes' // http://qt-project.org/doc/qt-4.8/graphicsview-elasticnodes.html #ifndef NODE_H #define NODE_H  #include <QGraphicsItem> #include <QList> #include <boost/signals2.hpp>  class Edge; class GraphWidget; class QGraphicsSceneMouseEvent;  class Node : public QGraphicsItem { public:   Node(GraphWidget *graphWidget);   Node(const Node&) = delete;   Node& operator=(const Node&) = delete;    void addEdge(Edge *edge) noexcept;   QList<Edge *> edges() const noexcept;    enum { Type = UserType + 1 };   int type() const noexcept override { return Type; }    void calculateForces() noexcept;   bool advance() noexcept;    QRectF boundingRect() const noexcept override;   QPainterPath shape() const noexcept override;   void paint(QPainter *painter, const QStyleOptionGraphicsItem *option, QWidget *widget) noexcept override;   void setShowBoundingRect(const bool show_bounding_rect) noexcept;    boost::signals2::signal<void(Node*)> m_signal_focus_changed;    protected:   QVariant itemChange(GraphicsItemChange change, const QVariant &value) noexcept override;    void focusInEvent(QFocusEvent *event) noexcept override;   void focusOutEvent(QFocusEvent *event) noexcept override;   void mousePressEvent(QGraphicsSceneMouseEvent *event) noexcept override;   void mouseReleaseEvent(QGraphicsSceneMouseEvent *event) noexcept override;    private:   QList<Edge*> m_edges;   GraphWidget * const m_graph;   QPointF m_new_pos;   bool m_show_bounding_rect; };  #endif`
  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 

 

 

 

 

./CppQtGraphExample5/node.cpp
-----------------------------

 

  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  ` // Adapted from Qt example 'Elastic nodes' // http://qt-project.org/doc/qt-4.8/graphicsview-elasticnodes.html  #include <QGraphicsScene> #include <QGraphicsSceneMouseEvent> #include <QPainter> #include <QStyleOption>  #include "edge.h" #include "node.h" #include "graphwidget.h"  Node::Node(GraphWidget *graphWidget)   :     m_signal_focus_changed{},     m_edges{},     m_graph(graphWidget),     m_new_pos{},     m_show_bounding_rect{false} {   setFlag(ItemIsMovable);   setFlag(ItemIsFocusable);   setFlag(ItemIsSelectable);   setFlag(ItemSendsGeometryChanges);   setCacheMode(DeviceCoordinateCache);   setZValue(-1); }  void Node::addEdge(Edge *edge) noexcept {   m_edges << edge;   edge->adjust(); }  bool Node::advance() noexcept {   if (m_new_pos == pos()) return false;    setPos(m_new_pos);   return true; }  QRectF Node::boundingRect() const noexcept {   const double adjust{2.0};   return QRectF(     -10.0 - adjust,     -10.0 - adjust,      23.0 + adjust,      23.0 + adjust    ); }  void Node::calculateForces() noexcept {   if (!scene() || scene()->mouseGrabberItem() == this)   {     m_new_pos = pos();     return;   }    // Sum up all forces pushing this item away   double xvel = 0.0;   double yvel = 0.0;   foreach (QGraphicsItem *item, scene()->items())   {     Node * const node = qgraphicsitem_cast<Node *>(item);      if (!node) continue;      const QPointF vec{mapToItem(node, 0.0, 0.0)};     const double dx{vec.x()};     const double dy{vec.y()};     const double l{2.0 * (dx * dx + dy * dy)};     if (l > 0.0)     {       xvel += (dx * 150.0) / l;       yvel += (dy * 150.0) / l;     }   }    // Now subtract all forces pulling items together   const double weight = static_cast<double>(m_edges.size() + 1) * 10.0;   foreach (Edge *edge, m_edges)   {     const QPointF vec       = edge->sourceNode() == this       ? mapToItem(edge->destNode(), 0, 0)       : mapToItem(edge->sourceNode(), 0, 0)     ;     xvel -= vec.x() / weight;     yvel -= vec.y() / weight;   }    if (qAbs(xvel) < 0.1 && qAbs(yvel) < 0.1)   {     xvel = yvel = 0.0;   }    const QRectF sceneRect = scene()->sceneRect();   m_new_pos = pos() + QPointF(xvel, yvel);   m_new_pos.setX(qMin(qMax(m_new_pos.x(), sceneRect.left() + 10), sceneRect.right() - 10));   m_new_pos.setY(qMin(qMax(m_new_pos.y(), sceneRect.top() + 10), sceneRect.bottom() - 10)); }  QList<Edge *> Node::edges() const noexcept {   return m_edges; }  void Node::focusInEvent(QFocusEvent *) noexcept {   m_signal_focus_changed(this); }  void Node::focusOutEvent(QFocusEvent *) noexcept {   m_signal_focus_changed(this); }  QVariant Node::itemChange(GraphicsItemChange change, const QVariant &value) noexcept {   switch (change) {     case ItemPositionHasChanged:     {       foreach (Edge *edge, m_edges)       edge->adjust();       m_graph->itemMoved();     }     break;     default:     break;   }    return QGraphicsItem::itemChange(change, value); }  void Node::mousePressEvent(QGraphicsSceneMouseEvent *event) noexcept {   update();   QGraphicsItem::mousePressEvent(event); }  void Node::mouseReleaseEvent(QGraphicsSceneMouseEvent *event) noexcept {   update();   QGraphicsItem::mouseReleaseEvent(event); }  void Node::paint(QPainter *painter, const QStyleOptionGraphicsItem *option, QWidget *) noexcept {   //Draw the shadow   painter->setPen(Qt::NoPen);   painter->setBrush(Qt::darkGray);   painter->drawEllipse(-7, -7, 20, 20);    QRadialGradient gradient(-3, -3, 10);    const bool is_selected{option->state & QStyle::State_Sunken     || this->isSelected() };   if (is_selected)   {     gradient.setCenter(3, 3);     gradient.setFocalPoint(3, 3);     gradient.setColorAt(1, QColor(Qt::lightGray).light(120));     gradient.setColorAt(0, QColor(Qt::darkGray).light(120));   }   else   {     gradient.setColorAt(0, Qt::lightGray);     gradient.setColorAt(1, Qt::darkGray);   }   painter->setBrush(gradient);    painter->setPen(     QPen(       Qt::black,       1.0, //pen width       is_selected ? Qt::DashLine : Qt::SolidLine     )   );   painter->drawEllipse(-10, -10, 20, 20);    //Draw the bounding rectangle   if (m_show_bounding_rect)   {     painter->setBrush(QBrush(QColor(255,0,0,32)));     painter->setPen(QPen(QColor(255,0,0,64)));     painter->drawRect(this->boundingRect());   } }  QPainterPath Node::shape() const noexcept {   QPainterPath path;   path.addEllipse(-10.0, -10.0, 20.0, 20.0);   return path; }`
  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 

 

 

 

 





 




This page has been created by the [tool](Tools.htm)
[CodeToHtml](ToolCodeToHtml.htm)
